---
# Dotfiles role: clone/pull dotfiles repo and create symlinks

- name: Check if dotfiles repo exists
  stat:
    path: "{{ dotfiles_dir }}/.git"
  register: dotfiles_repo

- name: Clone dotfiles repo (first time)
  git:
    repo: "{{ dotfiles_repo_url }}"
    dest: "{{ dotfiles_dir }}"
    version: main
    force: yes
  when: not dotfiles_repo.stat.exists

- name: Update dotfiles repo (if exists)
  git:
    repo: "{{ dotfiles_repo_url }}"
    dest: "{{ dotfiles_dir }}"
    update: yes
    force: yes
  when: dotfiles_repo.stat.exists

- name: Ensure .zsh directory exists in dotfiles repo
  file:
    path: "{{ dotfiles_dir }}/.zsh"
    state: directory
    mode: '0755'

- name: Ensure .zsh directory exists in home
  file:
    path: "{{ ansible_facts['user_dir'] }}/.zsh"
    state: directory
    mode: '0755'

- name: Create symlinks for dotfiles
  file:
    src: "{{ dotfiles_dir }}/{{ item.src }}"
    path: "{{ ansible_facts['user_dir'] }}/{{ item.dest }}"
    state: link
    force: yes
  loop:
    - { src: '.zshenv', dest: '.zshenv' }
    - { src: '.zshrc', dest: '.zshrc' }
    - { src: '.bashrc', dest: '.bashrc' }
    - { src: '.tmux.conf', dest: '.tmux.conf' }
    - { src: '.zsh/welcome.zsh', dest: '.zsh/welcome.zsh' }
    - { src: '.zsh/welcome-ssh.zsh', dest: '.zsh/welcome-ssh.zsh' }

- name: Create ghostty config directory (macOS desktop)
  file:
    path: "{{ ansible_facts['user_dir'] }}/Library/Application Support/com.mitchellh.ghostty"
    state: directory
    mode: '0755'
  when: ansible_facts['os_family'] == "Darwin"

- name: Symlink ghostty config (macOS)
  file:
    src: "{{ dotfiles_dir }}/ghostty.config"
    path: "{{ ansible_facts['user_dir'] }}/Library/Application Support/com.mitchellh.ghostty/config"
    state: link
    force: yes
  when: ansible_facts['os_family'] == "Darwin"

- name: Validate zsh config syntax
  shell: "zsh -n {{ ansible_facts['user_dir'] }}/.zshrc"
  changed_when: false
  failed_when: false
  when: shell == "zsh"

- name: Validate bash config syntax
  shell: "bash -n {{ ansible_facts['user_dir'] }}/.bashrc"
  changed_when: false
  failed_when: false
  when: shell == "bash"

- name: Display reload reminder
  debug:
    msg: "âœ… Dotfiles updated! Please restart your shell or run: exec $SHELL"
