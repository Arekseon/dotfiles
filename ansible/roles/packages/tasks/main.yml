---
# Packages role: install required packages

- name: Set OS family fact
  set_fact:
    os_family: "{{ ansible_facts['os_family'] }}"

- name: Install packages on Debian/Ubuntu
  apt:
    name: "{{ common_packages }}"
    state: present
    update_cache: yes
  when: os_family == "Debian"

- name: Install packages on macOS (Homebrew)
  homebrew:
    name: "{{ common_packages + mac_packages }}"
    state: present
  become: yes
  become_user: pk
  become_method: su
  when: os_family == "Darwin"
  ignore_errors: yes

# --- fd (not in apt) ---
- name: Install fd (Linux)
  unarchive:
    src: https://github.com/sharkdp/fd/releases/download/v10.2.0/fd-v10.2.0-x86_64-unknown-linux-gnu.tar.gz
    dest: /tmp
    remote_src: yes
    creates: /usr/local/bin/fd
  when: os_family == "Debian"

- name: Move fd binary
  copy:
    src: /tmp/fd-v10.2.0-x86_64-unknown-linux-gnu/fd
    dest: /usr/local/bin/fd
    remote_src: yes
    mode: '0755'
  when: os_family == "Debian"

# --- Starship ---
- name: Install starship via script (Linux)
  get_url:
    url: https://starship.rs/install.sh
    dest: /tmp/starship-install.sh
    mode: '0755'
  register: starship_install
  when: os_family == "Debian"

- name: Run starship installer (Linux)
  shell: /tmp/starship-install.sh -y
  when: starship_install.changed

- name: Install starship via Homebrew (macOS)
  homebrew:
    name: starship
    state: present
  become: yes
  become_user: pk
  become_method: su
  when: os_family == "Darwin"
  ignore_errors: yes
